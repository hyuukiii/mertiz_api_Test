<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head meta_vertical_guides="" meta_horizontal_guides="218">
        <w2:type>COMPONENT</w2:type>
        <w2:buildDate/>
        <w2:MSA/>
        <xf:model>
        	<w2:dataCollection baseNode="map">
        		<w2:dataMap baseNode="map" id="dma_insuInfo">
        			<w2:keyInfo>
        				<w2:key id="age" name="나이" dataType="number"></w2:key>
        				<w2:key id="diseaseCode" name="질병코드" dataType="text"></w2:key>
        				<w2:key id="premium" name="보험료" dataType="number"></w2:key>
        				<w2:key id="resultMsg" name="심사결과" dataType="text"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        		<w2:dataList baseNode="list" repeatNode="map" id="dlt_customerList" saveRemovedData="true">
        			<w2:columnInfo>
        				<w2:column id="custNo" name="고유ID" dataType="text"></w2:column>
        				<w2:column id="name" name="이름" dataType="text"></w2:column>
        				<w2:column id="age" name="나이" dataType="number"></w2:column>
        				<w2:column id="code" name="질병코드" dataType="number"></w2:column>
        				<w2:column id="result" name="심사결과" dataType="text"></w2:column>

        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataList baseNode="list" id="dlt_paymentLog" repeatNode="map" saveRemovedData="true" style="">
        			<w2:columnInfo>
        				<w2:column dataType="number" id="PAY_ID" name="결재아이디"></w2:column>
        				<w2:column dataType="text" id="USER_ID" name="유저아이디"></w2:column>
        				<w2:column dataType="number" id="AMOUNT" name="결재금액"></w2:column>
        				<w2:column dataType="text" id="PAY_DATE" name="결제일자"></w2:column>
        				<w2:column dataType="text" id="STATUS" name="상태"></w2:column>
        			</w2:columnInfo>
        		</w2:dataList>
        		<w2:dataMap baseNode="map" id="dma_searchParam">
        			<w2:keyInfo>
        				<w2:key id="page" name="현재페이지" dataType="text"></w2:key>
        				<w2:key id="size" name="크기" dataType="text"></w2:key>
        			</w2:keyInfo>
        		</w2:dataMap>
        	</w2:dataCollection>
        	<w2:workflowCollection />
        	<xf:submission id="sbm_saveData" ref="data:json,dlt_customerList" target="" action="http://localhost:8081/api/saveBatch"
        		method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler=""
        		mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="scwin.sbm_saveData_submitdone"
        		ev:submiterror="scwin.sbm_saveData_submiterror" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_getPayments" ref="" target="" action="http://localhost:8081/api/payments" method="get"
        		mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
        		processMsg="" ev:submit="" ev:submitdone="scwin.sbm_getPayments_submitdone" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        	<xf:submission id="sbm_getCustomers" ref="" target="data:json,dlt_customerList" action="http://localhost:8081/api/customers"
        		method="get" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler=""
        		customHandler="" mode="asynchronous" processMsg="" ev:submit="" ev:submitdone="" ev:submiterror="" abortTrigger="">
        	</xf:submission>
        </xf:model>
        <w2:layoutInfo/>
        <w2:publicInfo method=""/>
        <script lazy="false" type="text/javascript"><![CDATA[scwin.onpageload = function() {
};

scwin.btn_calc_onclick = function(e) {

const age = parseInt(dma_insuInfo.get("age"));
const code = dma_insuInfo.get("diseaseCode");

console.log("입력나이 :", age);
console.log("입력코드 :", code);


let finalPremium = 0;
let msg = "";

// 비즈니스 로직
if(code === "I10") {
    msg = "심사 거절 대상자 (고혈압)";
    finalPremium = 0;
} else {
    if ( age >= 50) {
        finalPremium = 50000;
        msg = "심사 승인 : 실버 플랜(50,000원)";
    } else {
        finalPremium = 30000;
        msg = "심사 승인 : 베이직 플랜(30,000원)";
    }
}

// 결과 반영
dma_insuInfo.set("premium", finalPremium);
dma_insuInfo.set("resultMsg", msg);

alert(msg);

};

// 조회
scwin.btn_search_onclick = function(e) {

$p.executeSubmission("sbm_getCustomers");
};


// 일괄 심사
scwin.btn_batch_onclick = function(e) {

// 1. 그리드에 있는 전체 데이터 건수 가져오기
const rowCount = dlt_customerList.getRowCount();

// 데이터 존재 유무 검증
if(rowCount === 0) {
    alert("먼저 전체 조회를 실행 해주세요.")
    return;
}

// 데이터 일괄처리 하기
for(let i = 0; i < rowCount; i++) {
    const age = parseInt(dlt_customerList.getCellData(i, "age"));
    const code = dlt_customerList.getCellData(i, "code");

    let msg = "";
    let finalPremium = 0;

    // 비즈니스 로직
    if(code === "I10") {
        msg = "거절 (고혈압)";
    } else {
        if (age >= 50) {
            finalPremium = 50000;
            msg = "실버 플랜";
        } else {
            finalPremium = 30000;
            msg = "베이직 플랜";
        }
    }

    // 심사 결과 현재 행의  result 컬럼에 세팅
    // 세팅하는 순간 그리드 화면도 즉시 업데이트 됨
    if(finalPremium > 0) {
        dlt_customerList.setCellData(i,"result", msg + "(" + finalPremium + "원)");
    } else {
        dlt_customerList.setCellData(i, "result", msg)
    }
}

alert(rowCount + "건의 일괄 심사가 완료되었습니다!");

};


/*
    * 저장
*/
scwin.btn_save_onclick = function(e) {
    const rowCount = dlt_customerList.getRowCount();

    // 아예 데이터가 없는 경우
    if(rowCount === 0) {
        alert("저장 할 데이터가 없습니다. 먼저 조회를 실행 해주세요");
    }

    // 심사결과가 비어있는지 확인
    for(let i = 0; i < rowCount; i++) {
        const resultVal = dlt_customerList.getCellData(i, "result");

        // result 값이 없거나 비어있는 경우
        if(!resultVal || resultVal.trim() === "") {
            alert("아직 심사가 완료되지 않은 데이터가 있습니다. \n먼저 [일괄심사]를 진행해주세요");
            return;
        }
    }

    // 심사결과 서브미션을 서버로 최종 전송한다
    if(confirm("심사 결과를 서버에 저장하시겠습니까?")) {
        $p.executeSubmission("sbm_saveData"); 
    }
};

// 통신 완료 콜백 함수 : submitDone
scwin.sbm_saveData_submitdone = function(e) {
    // e.responseJSON 안에 서버에서 보낸 결과값이 들어 있음
    console.log("서버 응답 결과:", e);
    alert("서버 저장이 완료 되었습니다!");

    $p.executeSubmission("sbm_getCustomers");
};


// 통신 실패 콜백 함수 : submiterror
scwin.sbm_saveData_submiterror = function(e) {
    // e 객체 안에 에러 코드, 상세 내용 들어 있음
    console.error("서버 전송 실패", e);

    // 사용자 알럿
    alert("서버 저장 중 오류가 발생했습니다. \n네트워크 상태를 확인하거나 관리자에게 문의 하세요.");
};


//하단 그리드 조회 버튼
scwin.btn_getPayment_onclick = function(e) {
    dma_searchParam.set("page", 1);
    scwin.searchList();
};
// 서브미션 성공 시
scwin.sbm_getPayments_submitdone = function(e) {
dlt_paymentLog.setJSON(e.responseJSON); // 서버에서 List(Map<String, Object) 를 사용하여 파싱 하는것이 안정적이고 올바르다
};


// [다음 페이지] 버튼 클릭
scwin.btn_next_onclick = function(e) {
// 1. 현재 페이지 번호 가져오기
let currentPage = dma_searchParam.get("page");
// 2. 페이지 번호 +1 하기
dma_searchParam.set("page", Number(currentPage) + 1);
scwin.searchList();
};

// [이전 페이지] 버튼 클릭
scwin.btn_prev_onclick = function(e) {
    let currentPage = dma_searchParam.get("page");

    // 1페이지보다 작아질 순 없으므로 검증 로직 추가
    if(Number(currentPage) > 1) {
        dma_searchParam.set("page", Number(currentPage) - 1);
        scwin.searchList();
    } else {
        alert("첫 번째 페이지입니다.");
    }
};


/*
    ****************
    *** 공통 함수 *** 
    *****************     
*/
scwin.searchList = function() {
    let page = dma_searchParam.get("page");
    let size = dma_searchParam.get("size") || 100;

    // API 주소 뒤에 파라미터를 동적으로
    let targetUrl = "http://localhost:8081/api/payments?page=" + page + "&size=" + size;

    // 서브미션 객체를 찾고 액션을 수정하여 서버로 전송
    let subObj = $p.getSubmission("sbm_getPayments");
    subObj.action = targetUrl;

    $p.executeSubmission("sbm_getPayments");   
};



scwin.btn_addRow_onclick = function(e) {
// 그리드의 총 데이터 건수 구하기
const rowIndex = dlt_customerList.getRowCount();

// 맨 마지막 줄에 빈 행을 추가
dlt_customerList.insertRow(rowIndex);

// 행이 추가 되면 마지막 줄에 포커스 -> 바로 타이핑 가능
dis_Grid.setFocusedCell(rowIndex, "custNo", true);

};


/*
    ****************
    =====행삭제=====
    ****************
*/
scwin.btn_delRow_onclick = function(e) {
    // 1. 그리드에서 현재 선택된 행의 번호를 가져 옴
    const focusedIndex = dis_Grid.getFocusedRowIndex();

    // 2. 방어 로직 : 아무 행도 선택하지 않은 상태라면?
    if(focusedIndex === -1) {
        alert("삭제할 행을 먼저 클릭해서 선택해주세요.");
        return;
    }

    // 3. 삭제 재차 확인
    if(confirm("선택하신 행을 삭제하시겠습니까? \n(※ [저장] 버튼을 눌러야 서버에 최종 반영됩니다.")) {
        dlt_customerList.deleteRow(focusedIndex);
    }
};
]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload">

    	<w2:textbox id="" label="질병코드 :"
    		style="position: static;; top:71px; left:131px; width:150px; height:23px;display:inline;font-size:14px;margin-right:8px;margin-left:10px;margin-top:0px;">
    	</w2:textbox>
    	<xf:input id="" ref="data:dma_insuInfo.diseaseCode" style="width: 144px;height: 21px;"></xf:input>
    	<w2:textbox id="" label="나이 :"
    		style="position: static;; top:71px; left:131px; width:150px; height:23px;display:inline;font-size:14px;margin-right:8px;margin-left:10px;margin-top:0px;">
    	</w2:textbox>
    	<xf:input class="wrap" id="" ref="data:dma_insuInfo.age" style="width: 144px;height: 21px;"></xf:input>
    	<xf:trigger ev:onclick="scwin.btn_calc_onclick" id="btn_calc"
    		style="position:static; top:100px; left:215px; width:80px; height:23px; ;margin-left:8px;" type="button">
    		<xf:label><![CDATA[심사실행]]></xf:label>
    	</xf:trigger>
    	<w2:gridView checkAllType="false" defaultCellHeight="20" id="dis_Grid" style="width:497px;height:392px;margin-top:12px;"
    		dataList="data:dlt_customerList" rowStatusVisible="true">
    		<w2:caption style="" id="caption1" value="this is a grid caption."></w2:caption>
    		<w2:header style="" id="header1">
    			<w2:row style="" id="row1">
    				<w2:column width="70" inputType="text" id="column1" value="고유ID" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" id="column3" value="이름" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" id="column4" value="나이" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" id="column5" value="질병코드" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" id="column6" value="심사결과" displayMode="label"></w2:column>
    			</w2:row>
    		</w2:header>
    		<w2:gBody style="" id="gBody1">
    			<w2:row style="" id="row2">
    				<w2:column width="70" inputType="text" id="custNo" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" id="name" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" id="age" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" id="code" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" id="result" displayMode="label"></w2:column>
    			</w2:row>
    		</w2:gBody>
    	</w2:gridView>
    	<xf:group id="" style=";margin-top:35px;">

    		<xf:trigger type="button" id="btn_addRow" style="width: 80px;height: 23px;margin-bottom:1px;" ev:onclick="scwin.btn_addRow_onclick">
    			<xf:label><![CDATA[행추가]]></xf:label>
    		</xf:trigger>
    		<xf:trigger type="button" id="btn_delRow" style="position:static; top:446px; left:122px; width:80px; height:23px; ;margin-left:2px;" ev:onclick="scwin.btn_delRow_onclick">
    			<xf:label><![CDATA[행삭제]]></xf:label>
    		</xf:trigger>

    		<xf:trigger ev:onclick="scwin.btn_search_onclick"
    			style="width: 80px;height: 23px;margin-left:6%;margin-top:8px;margin-bottom:10px;" id="btn_search" type="button">
    			<xf:label><![CDATA[조회]]></xf:label>
    		</xf:trigger>
    		<xf:trigger ev:onclick="scwin.btn_batch_onclick"
    			style="width: 80px;height: 23px;margin-top:7px;margin-left:4px;margin-bottom:10px;" id="btn_batch" type="button">
    			<xf:label><![CDATA[일괄심사]]></xf:label>
    		</xf:trigger>
    		<xf:trigger ev:onclick="scwin.btn_save_onclick"
    			style="width: 80px;height: 23px;margin-top:6px;margin-left:4px;margin-bottom:10px;" id="btn_save" type="button">
    			<xf:label><![CDATA[저장]]></xf:label>
    		</xf:trigger>
    	</xf:group>
    	<w2:gridView checkAllType="false" defaultCellHeight="20" id="" style="width:500px;height:195px;margin-bottom:12px;margin-top:35px;"
    		dataList="data:dlt_paymentLog">
    		<w2:caption style="" id="caption1" value="this is a grid caption."></w2:caption>
    		<w2:header style="" id="header1">
    			<w2:row style="" id="row1">
    				<w2:column width="70" inputType="text" style="" id="column1" value="결재아이디" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" style="" id="column4" value="유저아이디" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" style="" id="column5" value="결재금액" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" style="" id="column6" value="결제일자" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" style="" id="column7" value="상태" displayMode="label"></w2:column>
    			</w2:row>
    		</w2:header>
    		<w2:gBody style="" id="gBody1">
    			<w2:row style="" id="row2">
    				<w2:column width="70" inputType="text" style="" id="PAY_ID" value="" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" style="" id="USER_ID" value="" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" style="" id="AMOUNT" value="" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" style="" id="PAY_DATE" value="" displayMode="label"></w2:column>
    				<w2:column width="70" inputType="text" style="" id="STATUS" value="" displayMode="label"></w2:column>
    			</w2:row>
    		</w2:gBody>
    	</w2:gridView>
    	<xf:group id="" style=";margin-left:0%;">
    		<xf:trigger ev:onclick="scwin.btn_getPayment_onclick" style="width: 80px;height: 23px;margin-bottom:0px;margin-left:0%;"
    			id="btn_getPayment" type="button">
    			<xf:label><![CDATA[조회]]></xf:label>
    		</xf:trigger>
    		<xf:trigger style="position:static; top:685px; left:190px; width:80px; height:23px; ;margin-left:22%;" id="btn_prev" type="button"
    			ev:onclick="scwin.btn_prev_onclick">
    			<xf:label><![CDATA[이전]]></xf:label>
    		</xf:trigger>
    		<xf:trigger style="position:static; top:676px; left:555px; width:80px; height:23px; " id="btn_next" type="button"
    			ev:onclick="scwin.btn_next_onclick">
    			<xf:label><![CDATA[다음]]></xf:label>
    		</xf:trigger>
    	</xf:group>

    	
    </body>
</html>
